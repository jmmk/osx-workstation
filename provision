#! /usr/bin/env hy

(import [sh [which brew git chmod cp]])
(import subprocess)
(import shutil)
(import pytoml)
(import os)


(defn log [msg]
  (print "Provision: " msg))

(defn installed? [cmd]
  (bool (shutil.which cmd)))

(defn run-cmd [cmd]
  "Run shell command and squelch output"
  (apply subprocess.call [(+ cmd " &> /dev/null")] {"shell" true}))

(defn check-cmd [cmd]
  "Check if a shell command returns true or false"
  (zero? (run-cmd cmd)))

(defn default-set? [domain key value]
  (check-cmd (.format "defaults read {} {} | grep '^{}$'" domain key value)))

(defn write-default [entry format-vars]
  (let [[domain (.get entry "domain" "")]
        [key (.get entry "key" "")]
        [type (.get entry "type" "")]
        [value (apply .format [(.get entry "value" "")] format-vars)]]
    (unless (default-set? domain key value)
      (run-cmd (.format "defaults write {} {} {} {}" domain key type value)))))

(defn packages-to-install [installed requested-packages]
  (remove (fn [pkg] (in pkg installed)) requested-packages))

(defn parse-installed [packages]
  (set (.split packages)))

(defn brew-install-packages [packages installed install-fn]
  (apply install-fn (-> installed
                        (parse-installed)
                        (packages-to-install packages))))

(defn brew-cask-install [packages]
  (brew-install-packages packages (brew "cask" "list") (brew.bake "cask" "install")))

(defn brew-install [packages]
  (brew-install-packages packages (brew "list") (brew.bake "install")))

(defn brew-tap [taps]
  (brew-install-packages taps (brew "tap") (brew.bake "tap")))


(defmain [&rest args]
  (log "Brew update")
  (brew "update")

  (with [[f (open "config.toml" "r")]]
        (let [[config (pytoml.load f)]
              [homebrew-packages (get config "homebrew" "packages")]
              [homebrew-casks (get config "homebrew" "casks")]
              [homebrew-taps (get config "homebrew" "taps")]
              [plist-files (get config "files" "plist")]
              [osx-config (get config "osx" "config")]
              [osx-scripts (get config "osx" "scripts"]]

          (log "Tap extra Homebrew repos")
          (brew-tap homebrew-taps)

          (log "Install Homebrew Packages")
          (brew-install homebrew-packages)

          (log "Install Homebrew Casks")
          (brew-cask-install homebrew-casks)

          (log "Configure OS X Settings")
          (setv format-vars (get config "osx" "variables"))
          (setv osx-config-list (list-comp
                                  v
                                  [[k v] (.items osx-config)]))
          (setv osx-script-list (list-comp
                                  v
                                  [[k v] (.items osx-scripts)]))

          (for [config osx-config-list]
               (if (iterable? config)
                 (for [config config]
                      (write-default config format-vars))
                 (write-default config format-vars)))

          (for [script osx-script-list]
               (if (iterable? script)
                 (for [script script]
                      (run-cmd (apply .format [(get script "cmd")] format-vars)))
                 (run-cmd (apply .format [(get script "cmd")] format-vars))))

          (log "Move plist configurations")
          (setv files-dir (os.path.join (os.getcwd) "files")
          (setv plist-dir (os.path.expanduser "~/Library/Preferences"))
          (for [file plist-files]
               (let [[source (os.path.join files-dir file)]
                     [destination (os.path.join plist-dir file)]]
                 (cp source destination)
                 (chmod 600 destination)))))))

  (log "Install/Update dotfiles")
  (setv dotfiles-dir (os.path.expanduser "~/.dotfiles"))
  (setv dotfiles-git "git@github.com:jmmk/.dotfiles")

  (unless (os.path.isdir dotfiles-dir)
    (git "clone" "-q" "--depth" 1 dotfiles-git dotfiles-dir))

  (os.chdir dotfiles-dir)
  (git "pull" "-q" "origin" "master")
  (run-cmd "./setup")

  (setv zsh (which "zsh"))
  (unless (= (os.getenv "SHELL") zsh)
    (log "chsh to zsh")
    (run-cmd (.format "chsh -s {}" zsh))))
